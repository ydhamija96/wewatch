<div id="player"></div>
<div id="js_alert_container">{% module Alert("", "info") %}</div>

<script>
    function youtube_parser(url){
        var regExp = /^.*((youtu.be\/)|(v\/)|(\/u\/\w\/)|(embed\/)|(watch\?))\??v?=?([^#\&\?]*).*/;
        var match = url.match(regExp);
        return (match&&match[7].length==11)? match[7] : false;
    }

    var tag = document.createElement('script');

    tag.src = "https://www.youtube.com/iframe_api";
    var firstScriptTag = document.getElementsByTagName('script')[0];
    firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

    var player;
    function onYouTubeIframeAPIReady() {
        player = new YT.Player('player', {
            width: '100%',
            videoId: youtube_parser("{{ args['link'] }}"),
            events: {
                'onReady': onPlayerReady,
                'onStateChange': onPlayerStateChange
            }
        });
    }

    var ws = new WebSocket("{{ args['ws_url'] }}");
    var phase = "AUTH";

    ws.onopen = function() {
        var signed_auth = getCookie("user_auth");
        var raw_auth = parseTornadoSignedCookie(signed_auth);

        var to_send = new Object();
        to_send.user_id = "{{ args['user']['id'] }}";
        to_send.user_auth = raw_auth;
        to_send.video_id = "{{ args['id'] }}";
        to_send.invite_key = "{{ args['invite_key'] }}";
        to_send_string = JSON.stringify(to_send);
        ws.send(to_send_string);

        console.log("SENDING: " + to_send_string);
    };

    ws.onclose = function(evt){
        console.log("Websocket closed! Reason:")
        console.log(evt);

        $("#js_alert_container").find('.alert').html("Websocket closed! Reason:<br/><br/>" + evt.reason);
    }

    ws.onmessage = function (evt) {
        if(phase = "AUTH"){
            console.log(evt.data);
        }
    };

    function onPlayerReady(event) {
        event.target.playVideo();
    }

    function onPlayerStateChange(event) {
        console.log("onPlayerStateChange");
    }
</script>
